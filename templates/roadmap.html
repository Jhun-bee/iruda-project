{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- νμ΄μ§€ ν—¤λ” -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold iruda-blue">{{ current_user.name }}λ‹μ λ―Έλμ„¤κ³„ λ΅λ“λ§µ</h1>
            <button onclick="generateNewRoadmap()" 
                    class="iruda-bg-orange text-white px-4 py-2 rounded-lg hover:opacity-90">
                π”„ μƒ λ΅λ“λ§µ μƒμ„±
            </button>
        </div>

        {% if roadmap %}
            <!-- λ΅λ“λ§µ μ”μ•½ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-2xl font-semibold mb-4">{{ roadmap.title }}</h2>
                <p class="text-gray-600 mb-4">{{ roadmap.description }}</p>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    {% for area in roadmap.priority_areas %}
                        <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm">
                            {{ area }}
                        </span>
                    {% endfor %}
                </div>

                <!-- μ§„ν–‰λ¥  ν‘μ‹ -->
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-orange-500 h-2.5 rounded-full" style="width: {{ progress_percentage }}%"></div>
                </div>
                <p class="text-sm text-gray-600 mt-2">μ „μ²΄ μ§„ν–‰λ¥ : {{ progress_percentage }}%</p>
            </div>

            <!-- λ‹¨κΈ° λ©ν‘ μΉ΄λ“λ“¤ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                {% for period, goals in roadmap.timeline.items() %}
                    <div class="bg-white rounded-lg shadow-md p-6 relative">
                        <!-- κΈ°κ°„ ν—¤λ” -->
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold iruda-blue">{{ period }} λ©ν‘</h3>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                {{ goals|length }}κ° ν•­λ©
                            </span>
                        </div>

                        <!-- λ©ν‘ λ¦¬μ¤νΈ -->
                        <ul class="space-y-3 mb-4">
                            {% for goal in goals %}
                                <li class="flex items-start">
                                    <span class="text-orange-500 mr-2 mt-1">β€Ά</span>
                                    <span class="text-sm flex-1">{{ goal }}</span>
                                </li>
                            {% endfor %}
                        </ul>

                        <!-- μƒμ„Έν”λ λ²„νΌ -->
                        <button 
                            onclick="openDetailPlan('{{ period }}', {{ goals|tojson|safe }})"
                            class="w-full bg-gradient-to-r from-blue-500 to-orange-500 text-white py-2 px-4 rounded-lg hover:opacity-90 transition-opacity"
                        >
                            π“‹ μƒμ„Έν”λ λ³΄κΈ°
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- λ΅λ“λ§µμ΄ μ—†μ„ λ• -->
            <div class="bg-white rounded-lg shadow-md p-8 text-center">
                <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                    <span class="text-4xl">π—ΊοΈ</span>
                </div>
                <h2 class="text-2xl font-semibold mb-4">μ•„μ§ λ΅λ“λ§µμ΄ μ—†μµλ‹λ‹¤</h2>
                <p class="text-gray-600 mb-6">AIκ°€ λ¶„μ„ν• λ§μ¶¤ν• λ΅λ“λ§µμ„ μƒμ„±ν•΄λ³΄μ„Έμ”!</p>
                <button onclick="generateRoadmap()" 
                        class="iruda-bg-orange text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90">
                    π€ λ΅λ“λ§µ μƒμ„±ν•κΈ°
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- μƒμ„Έν”λ λ¨λ‹¬ -->
<div id="detailPlanModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <!-- λ¨λ‹¬ ν—¤λ” -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold iruda-blue" id="modalTitle">μƒμ„Έν”λ</h3>
                <button onclick="closeDetailPlan()" class="text-gray-400 hover:text-gray-600 text-2xl">Γ—</button>
            </div>

            <!-- μƒμ„Έν”λ λ‚΄μ© -->
            <div id="detailPlanContent"></div>

            <!-- λ¨λ‹¬ ν•λ‹¨ λ²„νΌλ“¤ -->
            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t">
                <button onclick="convertToTodos()" 
                        class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                    β… Todoλ΅ λ³€ν™
                </button>
                <button onclick="closeDetailPlan()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    λ‹«κΈ°
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPeriod = '';
let currentGoals = [];

function openDetailPlan(period, goals) {
    currentPeriod = period;
    currentGoals = goals;
    
    document.getElementById('modalTitle').textContent = `${period} μƒμ„Έν”λ`;
    
    // μƒμ„Έν”λ μ”μ²­
    fetch('/roadmap/detail-plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            period: period,
            goals: goals
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayDetailPlan(data.detail_plan);
        } else {
            document.getElementById('detailPlanContent').innerHTML = 
                '<p class="text-red-600">μƒμ„Έν”λμ„ λ¶λ¬μ¤λ”λ° μ‹¤ν¨ν–μµλ‹λ‹¤.</p>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('detailPlanContent').innerHTML = 
            '<p class="text-red-600">μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.</p>';
    });

    document.getElementById('detailPlanModal').classList.remove('hidden');
}

function displayDetailPlan(detailPlan) {
    let html = '<div class="space-y-6">';
    
    detailPlan.forEach((plan, index) => {
        html += `
            <div class="border border-gray-200 rounded-lg p-4">
                <h4 class="font-semibold text-lg mb-3 iruda-blue">${plan.title}</h4>
                <div class="space-y-2">
        `;
        
        plan.tasks.forEach(task => {
            // 'μ§€μ›'μ΄λ‚ 'μ‹ μ²­' ν‚¤μ›λ“κ°€ μλ”μ§€ ν™•μΈ
            const hasSupport = /μ§€μ›|μ‹ μ²­/g.test(task);
            if (hasSupport) {
                // μ§€μ›/μ‹ μ²­ λ¶€λ¶„μ„ ν΄λ¦­ κ°€λ¥ν•κ² λ§λ“¤κΈ°
                const highlightedTask = task.replace(/(μ§€μ›|μ‹ μ²­)/g, 
                    '<span class="text-orange-600 font-semibold cursor-pointer hover:underline" onclick="openPolicySearch(\'$1\')">$1</span>'
                );
                html += `<p class="text-sm text-gray-700">β€Ά ${highlightedTask}</p>`;
            } else {
                html += `<p class="text-sm text-gray-700">β€Ά ${task}</p>`;
            }
        });
        
        html += `
                </div>
                <div class="mt-3 text-xs text-gray-500">
                    μμƒ μ†μ”μ‹κ°„: ${plan.estimated_time || '1-2μ£Ό'}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('detailPlanContent').innerHTML = html;
}

function closeDetailPlan() {
    document.getElementById('detailPlanModal').classList.add('hidden');
}

function convertToTodos() {
    fetch('/roadmap/convert-to-todos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            period: currentPeriod,
            goals: currentGoals
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ν•  μΌ λ©λ΅μΌλ΅ μ¶”κ°€λμ—μµλ‹λ‹¤!');
            closeDetailPlan();
        } else {
            alert('λ³€ν™μ— μ‹¤ν¨ν–μµλ‹λ‹¤: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
    });
}

function openPolicySearch(type) {
    const searchQuery = type === 'μ§€μ›' ? 'μ§€μ›μ •μ±…' : 'μ‹ μ²­μ„λ¥';
    window.open(`/policies?search=${encodeURIComponent(searchQuery)}`, '_blank');
}

function generateRoadmap() {
    fetch('/generate-roadmap', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('λ΅λ“λ§µ μƒμ„±μ— μ‹¤ν¨ν–μµλ‹λ‹¤: ' + data.error);
        }
    })
    .catch(error => {
        alert('μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤: ' + error);
    });
}

function generateNewRoadmap() {
    if (confirm('μƒλ΅μ΄ λ΅λ“λ§µμ„ μƒμ„±ν•μ‹κ² μµλ‹κΉ? κΈ°μ΅΄ λ΅λ“λ§µμ€ λ°±μ—…λ©λ‹λ‹¤.')) {
        generateRoadmap();
    }
}
</script>
{% endblock %}