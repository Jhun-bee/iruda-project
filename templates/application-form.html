{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold iruda-blue mb-4">AI ì‹ ì²­ì„œ ìë™ ìƒì„±</h1>
            <p class="text-gray-600">ì •ì±… ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§ì¶¤í˜• ì‹ ì²­ì„œë¥¼ ìë™ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤</p>
        </div>

        <!-- ì •ì±… ì„ íƒ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">1. ì‹ ì²­í•  ì •ì±… ì„ íƒ</h2>
            {% if policy_name %}
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800">ì„ íƒëœ ì •ì±…</h3>
                    <p class="text-blue-700">{{ policy_name }}</p>
                    <input type="hidden" id="selectedPolicy" value="{{ policy_name }}">
                </div>
            {% else %}
                <div class="space-y-4">
                    <input type="text" id="policySearch" placeholder="ì •ì±…ëª…ì„ ê²€ìƒ‰í•˜ì„¸ìš”..." 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    <div id="policyResults" class="hidden space-y-2 max-h-40 overflow-y-auto">
                        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- ê°œì¸ ì •ë³´ ì…ë ¥ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">2. ê°œì¸ ì •ë³´ í™•ì¸</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„</label>
                    <input type="text" id="userName" value="{% if current_user %}{{ current_user.name }}{% endif %}"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ìƒë…„ì›”ì¼</label>
                    <input type="date" id="birthDate"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì „í™”ë²ˆí˜¸</label>
                    <input type="tel" id="phoneNumber" placeholder="010-0000-0000"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼</label>
                    <input type="email" id="email" value="{% if current_user %}{{ current_user.email }}{% endif %}"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì£¼ì†Œ</label>
                    <input type="text" id="address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬..."
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
            </div>
        </div>

        <!-- ì¶”ê°€ ì •ë³´ ì…ë ¥ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">3. ì¶”ê°€ ì •ë³´</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì›” ì†Œë“</label>
                    <select id="monthlyIncome" 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <option value="">ì†Œë“ ìˆ˜ì¤€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ì—†ìŒ">ì—†ìŒ</option>
                        <option value="50ë§Œì› ì´í•˜">50ë§Œì› ì´í•˜</option>
                        <option value="50-100ë§Œì›">50-100ë§Œì›</option>
                        <option value="100-150ë§Œì›">100-150ë§Œì›</option>
                        <option value="150-200ë§Œì›">150-200ë§Œì›</option>
                        <option value="200ë§Œì› ì´ìƒ">200ë§Œì› ì´ìƒ</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">í˜„ì¬ ìƒí™©</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="currentStatus" value="ìë¦½ì¤€ë¹„ì²­ë…„" class="mr-2">
                            ìë¦½ì¤€ë¹„ì²­ë…„
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="currentStatus" value="ëŒ€í•™ìƒ" class="mr-2">
                            ëŒ€í•™ìƒ
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="currentStatus" value="ì·¨ì—…ì¤€ë¹„ìƒ" class="mr-2">
                            ì·¨ì—…ì¤€ë¹„ìƒ
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="currentStatus" value="ì§ì¥ì¸" class="mr-2">
                            ì§ì¥ì¸
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="currentStatus" value="ë¬´ì§" class="mr-2">
                            ë¬´ì§
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="currentStatus" value="ê¸°íƒ€" class="mr-2">
                            ê¸°íƒ€
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì‹ ì²­ ì‚¬ìœ </label>
                    <textarea id="applicationReason" rows="4" placeholder="ì§€ì›ì´ í•„ìš”í•œ êµ¬ì²´ì ì¸ ì‚¬ìœ ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”..."
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"></textarea>
                </div>
            </div>
        </div>

        <!-- ìƒì„± ë²„íŠ¼ -->
        <div class="text-center mb-6">
            <button onclick="generateApplicationForm()" 
                    class="iruda-bg-orange text-white px-8 py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">
                ğŸ¤– AI ì‹ ì²­ì„œ ìƒì„±í•˜ê¸°
            </button>
        </div>

        <!-- ìƒì„±ëœ ì‹ ì²­ì„œ -->
        <div id="generatedForm" class="hidden bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">ìƒì„±ëœ ì‹ ì²­ì„œ</h2>
                <div class="space-x-2">
                    <button onclick="editForm()" 
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        âœï¸ ìˆ˜ì •
                    </button>
                    <button onclick="downloadForm()" 
                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                        ğŸ’¾ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button onclick="printForm()" 
                            class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        ğŸ–¨ï¸ ì¸ì‡„
                    </button>
                </div>
            </div>
            
            <div id="formContent" class="prose max-w-none">
                <!-- ìƒì„±ëœ ì‹ ì²­ì„œ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            
            <!-- í•„ìš” ì„œë¥˜ ì•ˆë‚´ -->
            <div id="requiredDocuments" class="mt-6 p-4 bg-yellow-50 rounded-lg">
                <h3 class="font-semibold text-yellow-800 mb-2">ğŸ“‹ í•„ìš” ì„œë¥˜</h3>
                <ul id="documentList" class="list-disc pl-5 text-sm text-yellow-700">
                    <!-- í•„ìš” ì„œë¥˜ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </ul>
            </div>

            <!-- ì œì¶œ ë°©ë²• ì•ˆë‚´ -->
            <div id="submissionGuide" class="mt-4 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-2">ğŸ“® ì œì¶œ ë°©ë²•</h3>
                <div id="submissionInfo" class="text-sm text-blue-700">
                    <!-- ì œì¶œ ë°©ë²• ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ë¡œë”© ëª¨ë‹¬ -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 text-center">
        <div class="animate-spin w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full mx-auto mb-4"></div>
        <h3 class="text-lg font-semibold mb-2">AIê°€ ì‹ ì²­ì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</h3>
        <p class="text-gray-600 text-sm">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>
</div>

<script>
// ì •ì±… ê²€ìƒ‰ ê¸°ëŠ¥
document.getElementById('policySearch')?.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    if (query.length > 2) {
        searchPolicies(query);
    } else {
        document.getElementById('policyResults').classList.add('hidden');
    }
});

function searchPolicies(query) {
    // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„œë²„ì—ì„œ ì •ì±… ê²€ìƒ‰
    // ì—¬ê¸°ì„œëŠ” ì„ì‹œë¡œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œ ì²˜ë¦¬
    fetch(`/policies/search?q=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(data => {
        displayPolicyResults(data.policies || []);
    })
    .catch(error => {
        console.error('Policy search error:', error);
    });
}

function displayPolicyResults(policies) {
    const resultsDiv = document.getElementById('policyResults');
    
    if (policies.length === 0) {
        resultsDiv.innerHTML = '<p class="text-gray-500 p-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    } else {
        resultsDiv.innerHTML = policies.map(policy => `
            <div class="p-2 hover:bg-gray-100 cursor-pointer rounded" onclick="selectPolicy('${policy.name}')">
                <h4 class="font-medium">${policy.name}</h4>
                <p class="text-sm text-gray-600">${policy.agency || ''}</p>
            </div>
        `).join('');
    }
    
    resultsDiv.classList.remove('hidden');
}

function selectPolicy(policyName) {
    document.getElementById('selectedPolicy').value = policyName;
    document.getElementById('policySearch').value = policyName;
    document.getElementById('policyResults').classList.add('hidden');
}

// AI ì‹ ì²­ì„œ ìƒì„±
function generateApplicationForm() {
    // ì…ë ¥ ë°ì´í„° ìˆ˜ì§‘
    const formData = collectFormData();
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!validateFormData(formData)) {
        return;
    }
    
    // ë¡œë”© ëª¨ë‹¬ í‘œì‹œ
    document.getElementById('loadingModal').classList.remove('hidden');
    
    // AI API í˜¸ì¶œ
    fetch('/generate-application-form', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayGeneratedForm(data.form_content, data.required_documents, data.submission_info);
        } else {
            alert('ì‹ ì²­ì„œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    })
    .finally(() => {
        document.getElementById('loadingModal').classList.add('hidden');
    });
}

function collectFormData() {
    const currentStatus = Array.from(document.querySelectorAll('input[name="currentStatus"]:checked'))
                              .map(cb => cb.value);
    
    return {
        policy_name: document.getElementById('selectedPolicy')?.value || document.getElementById('policySearch')?.value,
        user_name: document.getElementById('userName').value,
        birth_date: document.getElementById('birthDate').value,
        phone_number: document.getElementById('phoneNumber').value,
        email: document.getElementById('email').value,
        address: document.getElementById('address').value,
        monthly_income: document.getElementById('monthlyIncome').value,
        current_status: currentStatus,
        application_reason: document.getElementById('applicationReason').value
    };
}

function validateFormData(formData) {
    if (!formData.policy_name) {
        alert('ì‹ ì²­í•  ì •ì±…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return false;
    }
    if (!formData.user_name) {
        alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return false;
    }
    if (!formData.birth_date) {
        alert('ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return false;
    }
    if (!formData.phone_number) {
        alert('ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return false;
    }
    if (!formData.application_reason) {
        alert('ì‹ ì²­ ì‚¬ìœ ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.');
        return false;
    }
    return true;
}

function displayGeneratedForm(formContent, requiredDocuments, submissionInfo) {
    document.getElementById('formContent').innerHTML = formContent;
    
    // í•„ìš” ì„œë¥˜ í‘œì‹œ
    const documentList = document.getElementById('documentList');
    documentList.innerHTML = requiredDocuments.map(doc => `<li>${doc}</li>`).join('');
    
    // ì œì¶œ ë°©ë²• í‘œì‹œ
    document.getElementById('submissionInfo').innerHTML = submissionInfo;
    
    // ìƒì„±ëœ í¼ ì„¹ì…˜ í‘œì‹œ
    document.getElementById('generatedForm').classList.remove('hidden');
    
    // ìƒì„±ëœ í¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    document.getElementById('generatedForm').scrollIntoView({ behavior: 'smooth' });
}

function editForm() {
    // í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
    const formContent = document.getElementById('formContent');
    const currentContent = formContent.innerHTML;
    
    formContent.innerHTML = `
        <div class="space-y-4">
            <textarea class="w-full h-96 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" 
                      id="editableContent">${currentContent.replace(/<[^>]*>/g, '')}</textarea>
            <div class="flex space-x-2">
                <button onclick="saveEdits()" 
                        class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                    ì €ì¥
                </button>
                <button onclick="cancelEdit('${currentContent.replace(/'/g, "\\\'")}')" 
                        class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    `;
}

function saveEdits() {
    const editedContent = document.getElementById('editableContent').value;
    document.getElementById('formContent').innerHTML = `<div class="whitespace-pre-wrap">${editedContent}</div>`;
}

function cancelEdit(originalContent) {
    document.getElementById('formContent').innerHTML = originalContent;
}

function downloadForm() {
    const formContent = document.getElementById('formContent').innerText;
    const blob = new Blob([formContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ì‹ ì²­ì„œ.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function printForm() {
    const formContent = document.getElementById('generatedForm').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>ì‹ ì²­ì„œ</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .prose { max-width: none; }
                @media print { 
                    button { display: none; } 
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            ${formContent}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}
</script>
{% endblock %}