{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-orange-50">
    <!-- ì•Œë¦¼ ë°°ë„ˆ -->
    <div id="notificationBanner" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 z-50 max-w-md w-full mx-4">
        <div class="bg-white border-l-4 border-red-500 shadow-lg rounded-lg p-4 animate-fadeInDown">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <span class="text-red-500 text-xl">âš ï¸</span>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-sm font-medium text-red-800" id="notificationText"></p>
                </div>
                <div class="ml-4 flex-shrink-0">
                    <button onclick="closeNotification()" class="text-red-400 hover:text-red-600 focus:outline-none">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- í—¤ë” ì¸ì‚¬ë§ -->
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-12">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full mb-6 shadow-lg">
                <span class="text-2xl">ğŸ‘‹</span>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-gradient mb-4">
                {{ current_user.name }}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!
            </h1>
            <p class="text-xl text-gray-600" id="motivationalMessage">ì˜¤ëŠ˜ë„ ìë¦½ì„ í–¥í•œ í•œ ê±¸ìŒì„ ë‚´ë”›ì–´ë³´ì„¸ìš”!</p>
        </div>

        <!-- í†µê³„ ì¹´ë“œ (ê°œì„ ëœ ë²„ì „) -->
        <div class="max-w-7xl mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="stat-card group">
                <div class="stat-icon bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600 group-hover:scale-110 transition-transform">
                    <span class="text-2xl">ğŸ“</span>
                </div>
                <div class="stat-number text-blue-600" id="activeTasks">-</div>
                <div class="stat-label">ì§„í–‰ì¤‘ì¸ í•  ì¼</div>
                <div class="mt-2">
                    <span id="dueTodayBadge" class="hidden badge badge-warning">
                        ì˜¤ëŠ˜ ë§ˆê°: <span id="dueTodayCount">0</span>ê°œ
                    </span>
                </div>
            </div>
            
            <div class="stat-card group">
                <div class="stat-icon bg-gradient-to-br from-green-100 to-green-200 text-green-600 group-hover:scale-110 transition-transform">
                    <span class="text-2xl">âœ…</span>
                </div>
                <div class="stat-number text-green-600" id="completedTasks">-</div>
                <div class="stat-label">ì™„ë£Œí•œ í•  ì¼</div>
                <div class="text-xs text-gray-400 mt-1">ì´ë²ˆ ë‹¬ ì™„ë£Œ</div>
            </div>
            
            <div class="stat-card group">
                <div class="stat-icon bg-gradient-to-br from-orange-100 to-orange-200 text-orange-600 group-hover:scale-110 transition-transform">
                    <span class="text-2xl">ğŸ¯</span>
                </div>
                <div class="stat-number text-orange-600" id="recommendedPolicies">-</div>
                <div class="stat-label">ì¶”ì²œ ì •ì±…</div>
                <div class="text-xs text-gray-400 mt-1">ë§ì¶¤ ì¶”ì²œ</div>
            </div>
            
            <div class="stat-card group">
                <div class="stat-icon bg-gradient-to-br from-purple-100 to-purple-200 text-purple-600 group-hover:scale-110 transition-transform">
                    <span class="text-2xl">ğŸ“Š</span>
                </div>
                <div class="stat-number text-purple-600" id="completionRate">-</div>
                <div class="stat-label">ë‹¬ì„±ë¥ </div>
                <div class="text-xs text-gray-400 mt-1">ì´ë²ˆ ë‹¬ í‰ê· </div>
            </div>
        </div>

        <!-- ì¤‘ì•™ ëŒ€í™”ì°½ -->
        <div class="max-w-5xl mx-auto mb-12">
            <div class="chat-container" id="chatContainer">
                <!-- ëŒ€í™” í—¤ë” -->
                <div class="chat-header">
                    <div class="flex items-center justify-between w-full">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <span class="text-lg">ğŸ¤–</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">ì´ë£¨ë‹¤ AI ìƒë‹´ì‚¬</h3>
                                <span class="text-sm opacity-90">ì˜¨ë¼ì¸</span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="loadChatHistory()" class="text-white hover:text-gray-200 text-sm px-3 py-1 rounded-lg hover:bg-white hover:bg-opacity-10 transition-colors">
                                ğŸ“‹ ì´ì „ ëŒ€í™”
                            </button>
                            <button onclick="clearChat()" class="text-white hover:text-gray-200 text-sm px-3 py-1 rounded-lg hover:bg-white hover:bg-opacity-10 transition-colors">
                                ğŸ—‘ï¸ ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ëŒ€í™” ì˜ì—­ -->
                <div id="chatMessages" class="chat-messages">
                    <div class="chat-message bot">
                        <div class="message-avatar bg-gradient-to-br from-orange-400 to-orange-600 text-white">
                            AI
                        </div>
                        <div class="message-content bot">
                            <p id="welcomeMessage">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ë¡œë“œë§µ ì„¤ê³„ë‚˜ ì§€ì›ì •ì±… ì°¾ê¸°ë¥¼ ë„ì™€ë“œë¦´ ìˆ˜ ìˆì–´ìš”!</p>
                        </div>
                    </div>
                </div>

                <!-- ì…ë ¥ ì˜ì—­ -->
                <div class="chat-input">
                    <div class="flex space-x-3">
                        <input 
                            type="text" 
                            id="chatInput" 
                            placeholder="ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”..."
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                            onkeypress="handleKeyPress(event)"
                        >
                        <button 
                            onclick="sendMessage()" 
                            class="btn-primary flex items-center px-6 py-3"
                            id="sendBtn"
                        >
                            <span id="sendBtnText">ì „ì†¡</span>
                            <span id="sendBtnSpinner" class="hidden ml-2 spinner"></span>
                        </button>
                    </div>

                    <!-- ë¹ ë¥¸ ë²„íŠ¼ë“¤ -->
                    <div class="flex flex-wrap gap-2 mt-4" id="quickButtons">
                        <button onclick="quickMessage('ë¡œë“œë§µì„ ë§Œë“¤ê³  ì‹¶ì–´ìš”')" 
                                class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full text-sm hover:bg-blue-200 transition-colors font-medium">
                            ğŸ—ºï¸ ë¡œë“œë§µ ë§Œë“¤ê¸°
                        </button>
                        <button onclick="quickMessage('ì§€ì›ì •ì±…ì„ ì°¾ê³  ìˆì–´ìš”')" 
                                class="px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm hover:bg-green-200 transition-colors font-medium">
                            ğŸ’° ì§€ì›ì •ì±… ì°¾ê¸°
                        </button>
                        <button onclick="quickMessage('ì˜¤ëŠ˜ í•  ì¼ì„ ì•Œê³  ì‹¶ì–´ìš”')" 
                                class="px-4 py-2 bg-purple-100 text-purple-800 rounded-full text-sm hover:bg-purple-200 transition-colors font-medium">
                            âœ… í•  ì¼ í™•ì¸
                        </button>
                        <button onclick="quickMessage('ì—°ì²´ëœ í•  ì¼ì„ ì¬ê³„íší•˜ê³  ì‹¶ì–´ìš”')" 
                                class="px-4 py-2 bg-red-100 text-red-800 rounded-full text-sm hover:bg-red-200 transition-colors font-medium">
                            ğŸ”„ ì—°ì²´ ì¬ê³„íš
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì•¡ì…˜ ì¹´ë“œë“¤ -->
        <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
            <!-- ë¯¸ë˜ì„¤ê³„ ë¡œë“œë§µ -->
            <div class="card card-interactive group" onclick="location.href='/roadmap'">
                <div class="text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform shadow-lg">
                        <span class="text-3xl text-white">ğŸ—ºï¸</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">ë¯¸ë˜ì„¤ê³„ ë¡œë“œë§µ</h3>
                    <p class="text-gray-600 mb-6 leading-relaxed">AIê°€ ë¶„ì„í•œ ë§ì¶¤í˜• ìë¦½ ê³„íšì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
                    <div class="btn-secondary">
                        ë¡œë“œë§µ ë³´ê¸° â†’
                    </div>
                </div>
            </div>

            <!-- ì§€ì›ì •ì±… ë°”ë¡œì°¾ê¸° -->
            <div class="card card-interactive group" onclick="location.href='/policies'">
                <div class="text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform shadow-lg">
                        <span class="text-3xl text-white">ğŸ’°</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">ì§€ì›ì •ì±… ë°”ë¡œì°¾ê¸°</h3>
                    <p class="text-gray-600 mb-6 leading-relaxed">ë‚˜ì—ê²Œ ë§ëŠ” ì •ë¶€ ì§€ì›ì •ì±…ì„ ì‰½ê²Œ ì°¾ì•„ë³´ì„¸ìš”</p>
                    <div class="btn-primary">
                        ì •ì±… ì°¾ê¸° â†’
                    </div>
                </div>
            </div>

            <!-- í•  ì¼ ê´€ë¦¬ -->
            <div class="card card-interactive group" onclick="location.href='/todos'">
                <div class="text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform shadow-lg">
                        <span class="text-3xl text-white">âœ…</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">í•  ì¼ ê´€ë¦¬</h3>
                    <p class="text-gray-600 mb-6 leading-relaxed">ì²´ê³„ì ì¸ í•  ì¼ ê´€ë¦¬ë¡œ ëª©í‘œë¥¼ ì°¨ê·¼ì°¨ê·¼ ë‹¬ì„±í•˜ì„¸ìš”</p>
                    <div class="btn-outline" style="border-color: #10b981; color: #10b981;">
                        í•  ì¼ ë³´ê¸° â†’
                    </div>
                </div>
            </div>
        </div>

        <!-- ìµœê·¼ í™œë™ ë° ì§„í–‰ìƒí™© -->
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- ìµœê·¼ í™œë™ -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                            <span class="text-white text-lg">ğŸ“Š</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">ìµœê·¼ í™œë™</h3>
                    </div>
                    <div id="recentActivity" class="space-y-4">
                        <div class="flex items-center space-x-4 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-100 to-blue-200 rounded-lg flex items-center justify-center flex-shrink-0">
                                <span class="text-blue-600">ğŸ“</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-800">í•  ì¼ 3ê°œ ì™„ë£Œ</p>
                                <p class="text-xs text-gray-500">2ì‹œê°„ ì „</p>
                            </div>
                            <div class="badge badge-success">ì™„ë£Œ</div>
                        </div>
                        <div class="flex items-center space-x-4 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                            <div class="w-10 h-10 bg-gradient-to-br from-green-100 to-green-200 rounded-lg flex items-center justify-center flex-shrink-0">
                                <span class="text-green-600">ğŸ—ºï¸</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-800">ë¡œë“œë§µ ì—…ë°ì´íŠ¸</p>
                                <p class="text-xs text-gray-500">ì–´ì œ</p>
                            </div>
                            <div class="badge badge-info">ì—…ë°ì´íŠ¸</div>
                        </div>
                        <div class="flex items-center space-x-4 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                            <div class="w-10 h-10 bg-gradient-to-br from-orange-100 to-orange-200 rounded-lg flex items-center justify-center flex-shrink-0">
                                <span class="text-orange-600">ğŸ’°</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-800">ì§€ì›ì •ì±… 3ê°œ ì°¾ìŒ</p>
                                <p class="text-xs text-gray-500">3ì¼ ì „</p>
                            </div>
                            <div class="badge badge-warning">ë°œê²¬</div>
                        </div>
                    </div>
                </div>
                
                <!-- ì§„í–‰ í˜„í™© -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                            <span class="text-white text-lg">ğŸ“ˆ</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">ì´ë²ˆ ë‹¬ ì§„í–‰ í˜„í™©</h3>
                    </div>
                    <div class="space-y-6">
                        <!-- ì™„ë£Œìœ¨ ì°¨íŠ¸ -->
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm font-medium text-gray-700">í•  ì¼ ì™„ë£Œìœ¨</span>
                                <span class="text-sm font-bold text-purple-600" id="progressPercentage">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- ì¹´í…Œê³ ë¦¬ë³„ ì§„í–‰ -->
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">ì£¼ê±° ê´€ë ¨</span>
                                <div class="flex items-center space-x-3">
                                    <div class="w-20 bg-gray-200 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500" style="width: 75%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-600 w-8">3/4</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">ì·¨ì—… ì¤€ë¹„</span>
                                <div class="flex items-center space-x-3">
                                    <div class="w-20 bg-gray-200 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-green-500 to-green-600 h-2 rounded-full transition-all duration-500" style="width: 50%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-600 w-8">2/4</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">ê²½ì œ ê´€ë¦¬</span>
                                <div class="flex items-center space-x-3">
                                    <div class="w-20 bg-gray-200 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 h-2 rounded-full transition-all duration-500" style="width: 25%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-600 w-8">1/4</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
let conversationHistory = [];

// ì±„íŒ… ê¸°ëŠ¥ (ê°œì„ ëœ ë²„ì „)
function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;

    // ì „ì†¡ ë²„íŠ¼ ë¡œë”© ìƒíƒœ
    const sendBtn = document.getElementById('sendBtn');
    const sendBtnText = document.getElementById('sendBtnText');
    const sendBtnSpinner = document.getElementById('sendBtnSpinner');
    
    sendBtn.disabled = true;
    sendBtnText.textContent = 'ì „ì†¡ ì¤‘...';
    sendBtnSpinner.classList.remove('hidden');

    addUserMessage(message);
    input.value = '';

    // ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
    conversationHistory.push({role: "user", content: message});

    // OpenAI API í˜¸ì¶œ (ëŒ€í™” íˆìŠ¤í† ë¦¬ í¬í•¨)
    fetch('/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            history: conversationHistory
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addBotMessage(data.response);
            conversationHistory.push({role: "assistant", content: data.response});
            
            // ëŒ€í™” íˆìŠ¤í† ë¦¬ ì €ì¥
            saveChatHistory(message, data.response);
            
            // í˜ì´ì§€ ì´ë™ ì œì•ˆì´ ìˆë‹¤ë©´ ì²˜ë¦¬
            if (data.suggestion) {
                handleSuggestion(data.suggestion);
            }
        } else {
            addBotMessage("ì£„ì†¡í•©ë‹ˆë‹¤. ì ì‹œ ë¬¸ì œê°€ ìˆì—ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addBotMessage("ì—°ê²°ì— ë¬¸ì œê°€ ìˆì—ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    })
    .finally(() => {
        // ì „ì†¡ ë²„íŠ¼ ì›ë˜ ìƒíƒœë¡œ
        sendBtn.disabled = false;
        sendBtnText.textContent = 'ì „ì†¡';
        sendBtnSpinner.classList.add('hidden');
    });
}

function addUserMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message user animate-fadeInUp';
    messageDiv.innerHTML = `
        <div class="message-content user">
            <p>${escapeHtml(message)}</p>
        </div>
        <div class="message-avatar bg-gradient-to-br from-gray-400 to-gray-500 text-white">
            ë‚˜
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addBotMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message bot animate-fadeInUp';
    messageDiv.innerHTML = `
        <div class="message-avatar bg-gradient-to-br from-orange-400 to-orange-600 text-white">
            AI
        </div>
        <div class="message-content bot">
            <p>${escapeHtml(message)}</p>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function quickMessage(message) {
    document.getElementById('chatInput').value = message;
    sendMessage();
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function clearChat() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = `
        <div class="chat-message bot">
            <div class="message-avatar bg-gradient-to-br from-orange-400 to-orange-600 text-white">
                AI
            </div>
            <div class="message-content bot">
                <p>ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ë¡œë“œë§µ ì„¤ê³„ë‚˜ ì§€ì›ì •ì±… ì°¾ê¸°ë¥¼ ë„ì™€ë“œë¦´ ìˆ˜ ìˆì–´ìš”!</p>
            </div>
        </div>
    `;
    conversationHistory = [];
}

function handleSuggestion(suggestion) {
    if (suggestion.type === 'redirect') {
        setTimeout(() => {
            if (confirm(`${suggestion.message}\n\ní˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                location.href = suggestion.url;
            }
        }, 1000);
    }
}

// ëŒ€í™” íˆìŠ¤í† ë¦¬ ì €ì¥
function saveChatHistory(userMessage, aiResponse) {
    fetch('/chat/save-history', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_message: userMessage,
            ai_response: aiResponse
        })
    })
    .catch(error => console.error('History save error:', error));
}

// ëŒ€í™” íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
function loadChatHistory() {
    fetch('/chat/history')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.history.length > 0) {
            showChatHistoryModal(data.history);
        } else {
            alert('ì´ì „ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => console.error('History load error:', error));
}

// HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    updateDashboardStats();
    checkNotifications();
    setMotivationalMessage();
    loadRecentActivity();
});

// ëŒ€ì‹œë³´ë“œ í†µê³„ ì—…ë°ì´íŠ¸ (ê°œì„ ëœ ë²„ì „)
function updateDashboardStats() {
    fetch('/dashboard-stats')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('activeTasks').textContent = data.active_tasks || 0;
            document.getElementById('completedTasks').textContent = data.completed_tasks || 0;
            document.getElementById('recommendedPolicies').textContent = data.recommended_policies || 0;
            
            // ì˜¤ëŠ˜ ë§ˆê° í• ì¼ ë°°ì§€ í‘œì‹œ
            if (data.due_today > 0) {
                document.getElementById('dueTodayBadge').classList.remove('hidden');
                document.getElementById('dueTodayCount').textContent = data.due_today;
            }
            
            // ì™„ë£Œìœ¨ ê³„ì‚° ë° í‘œì‹œ
            const total = data.active_tasks + data.completed_tasks;
            const completionRate = total > 0 ? Math.round((data.completed_tasks / total) * 100) : 0;
            document.getElementById('completionRate').textContent = completionRate + '%';
            
            // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
            document.getElementById('progressPercentage').textContent = completionRate + '%';
            document.getElementById('progressBar').style.width = completionRate + '%';
            
            // ì—°ì²´ëœ í• ì¼ì´ ìˆìœ¼ë©´ ì•Œë¦¼ í‘œì‹œ
            if (data.overdue_tasks > 0) {
                showNotification(`ì—°ì²´ëœ í•  ì¼ì´ ${data.overdue_tasks}ê°œ ìˆìŠµë‹ˆë‹¤. í™•ì¸í•´ë³´ì„¸ìš”!`, 'warning');
            }
        }
    })
    .catch(error => console.error('Stats error:', error));
}

// ì•Œë¦¼ í™•ì¸ ë° í‘œì‹œ
function checkNotifications() {
    fetch('/notifications')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.counts.overdue > 0) {
            showNotification(`ì—°ì²´ëœ í•  ì¼ì´ ${data.counts.overdue}ê°œ ìˆìŠµë‹ˆë‹¤!`, 'error');
        }
    })
    .catch(error => console.error('Notification error:', error));
}

// ì•Œë¦¼ ë°°ë„ˆ í‘œì‹œ
function showNotification(message, type = 'info') {
    const banner = document.getElementById('notificationBanner');
    const text = document.getElementById('notificationText');
    const bannerContent = banner.querySelector('.bg-white');
    
    text.textContent = message;
    
    // íƒ€ì…ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ë³€ê²½
    if (type === 'error') {
        bannerContent.className = 'bg-white border-l-4 border-red-500 shadow-lg rounded-lg p-4 animate-fadeInDown';
    } else if (type === 'warning') {
        bannerContent.className = 'bg-white border-l-4 border-yellow-500 shadow-lg rounded-lg p-4 animate-fadeInDown';
    } else {
        bannerContent.className = 'bg-white border-l-4 border-blue-500 shadow-lg rounded-lg p-4 animate-fadeInDown';
    }
    
    banner.classList.remove('hidden');
    
    // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€
    setTimeout(() => {
        closeNotification();
    }, 5000);
}

// ì•Œë¦¼ ë‹«ê¸°
function closeNotification() {
    document.getElementById('notificationBanner').classList.add('hidden');
}

// ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€ ì„¤ì •
function setMotivationalMessage() {
    const messages = [
        "ì˜¤ëŠ˜ë„ ìë¦½ì„ í–¥í•œ í•œ ê±¸ìŒì„ ë‚´ë”›ì–´ë³´ì„¸ìš”!",
        "ì‘ì€ ì‹¤ì²œì´ í° ë³€í™”ë¥¼ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤!",
        "ë‹¹ì‹ ì˜ ê¿ˆì„ ì‘ì›í•©ë‹ˆë‹¤!",
        "í•œ ë²ˆì— í•˜ë‚˜ì”©, ì²œì²œíˆ í•´ë‚˜ê°€ë©´ ë©ë‹ˆë‹¤!",
        "ì´ë£¨ë‹¤ê°€ í•­ìƒ ê³ì—ì„œ ë„ì™€ë“œë¦´ê²Œìš”!"
    ];
    
    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
    document.getElementById('motivationalMessage').textContent = randomMessage;
}

// ìµœê·¼ í™œë™ ë¡œë“œ (ì‹¤ì œ ë°ì´í„°ë¡œ ëŒ€ì²´ ì˜ˆì •)
function loadRecentActivity() {
    // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
    console.log('Recent activity loaded');
}
</script>
{% endblock %}