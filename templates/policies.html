{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold iruda-blue">ì§€ì›ì •ì±… ë°”ë¡œì°¾ê¸°</h1>
            <div class="flex items-center space-x-4">
                <button onclick="openApplicationForm()" 
                        class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                    ğŸ“ ì‹ ì²­ì–‘ì‹ ë§Œë“¤ê¸°
                </button>
                <button onclick="recommendPolicies()" 
                        class="iruda-bg-orange text-white px-4 py-2 rounded-lg hover:opacity-90">
                    ğŸ¯ ë§ì¶¤ ì¶”ì²œ
                </button>
            </div>
        </div>

        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                    <input type="text" id="searchInput" placeholder="ì •ì±…ëª…, ê¸°ê´€ëª…, ì§€ì›ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰..." 
                           value="{{ request.args.get('search', '') }}"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                <select id="categoryFilter" 
                        class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    <option value="">ì „ì²´ êµ¬ë¶„</option>
                    <option value="ì¤‘ì•™ë¶€ì²˜">ì¤‘ì•™ë¶€ì²˜</option>
                    <option value="ì§€ìì²´">ì§€ìì²´</option>
                    <option value="ë¯¼ê°„">ë¯¼ê°„</option>
                </select>
                <button onclick="searchPolicies()" 
                        class="iruda-bg-blue text-white px-4 py-2 rounded-lg hover:opacity-90">
                    ğŸ” ê²€ìƒ‰
                </button>
            </div>
            
            <!-- ë¹ ë¥¸ í•„í„° íƒœê·¸ -->
            <div class="flex flex-wrap gap-2 mt-4">
                <span class="text-sm text-gray-600">ë¹ ë¥¸ ê²€ìƒ‰:</span>
                <button onclick="quickSearch('ì£¼ê±°')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm hover:bg-blue-200">ğŸ  ì£¼ê±°ì§€ì›</button>
                <button onclick="quickSearch('ìƒê³„')" class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm hover:bg-green-200">ğŸ’° ìƒê³„ì§€ì›</button>
                <button onclick="quickSearch('ì·¨ì—…')" class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm hover:bg-purple-200">ğŸ’¼ ì·¨ì—…ì§€ì›</button>
                <button onclick="quickSearch('êµìœ¡')" class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm hover:bg-yellow-200">ğŸ“š êµìœ¡ì§€ì›</button>
                <button onclick="quickSearch('ì˜ë£Œ')" class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm hover:bg-red-200">ğŸ¥ ì˜ë£Œì§€ì›</button>
            </div>
        </div>

        <!-- ì •ì±… ëª©ë¡ -->
        <div id="policiesContainer">
            {% if policies %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for policy in policies %}
                        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                            <!-- ì •ì±… í—¤ë” -->
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-semibold iruda-blue line-clamp-2">{{ policy.ì„œë¹„ìŠ¤ëª… }}</h3>
                                <span class="px-2 py-1 text-xs rounded-full
                                    {% if policy.êµ¬ë¶„ == 'ì¤‘ì•™ë¶€ì²˜' %}bg-blue-100 text-blue-800
                                    {% elif policy.êµ¬ë¶„ == 'ì§€ìì²´' %}bg-green-100 text-green-800
                                    {% else %}bg-purple-100 text-purple-800{% endif %}">
                                    {{ policy.êµ¬ë¶„ }}
                                </span>
                            </div>

                            <!-- ìƒˆë¡œìš´ ë§¤ì¹­ ì •ë³´ ì¶”ê°€ -->
                            {% if policy.get('_match_info') %}
                            <div class="match-info mb-3 p-2 bg-gray-50 rounded-lg">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">
                                        ê´€ë ¨ë„: <span class="font-medium text-blue-600">{{ (policy._match_info.semantic_score * 100)|round }}%</span>
                                    </span>
                                    {% if policy._match_info.eligible %}
                                        <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">âœ… ì‹ ì²­ ê°€ëŠ¥</span>
                                    {% else %}
                                        <span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">âš ï¸ ì¡°ê±´ í™•ì¸ í•„ìš”</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- ê¸°ê´€ ì •ë³´ -->
                            <div class="text-sm text-gray-600 mb-3">
                                <p><strong>ê¸°ê´€:</strong> {{ policy.ê¸°ê´€ëª… }}</p>
                                {% if policy.ì—°ë½ì²˜ %}
                                    <p><strong>ì—°ë½ì²˜:</strong> {{ policy.ì—°ë½ì²˜ }}</p>
                                {% endif %}
                            </div>

                            <!-- ì§€ì› ëŒ€ìƒ -->
                            <div class="mb-3">
                                <p class="text-sm font-medium text-gray-700 mb-1">ì§€ì›ëŒ€ìƒ:</p>
                                <p class="text-xs text-gray-600 line-clamp-3">{{ policy.ì§€ì›ëŒ€ìƒ }}</p>
                            </div>

                            <!-- ì§€ì› ë‚´ìš© -->
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-1">ì§€ì›ë‚´ìš©:</p>
                                <p class="text-xs text-gray-600 line-clamp-2">{{ policy.ì§€ì›ë‚´ìš© }}</p>
                            </div>

                            <!-- ì‹ ì²­ ë°©ë²• -->
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-1">ì‹ ì²­ë°©ë²•:</p>
                                <p class="text-xs text-gray-600 line-clamp-2">{{ policy.ì‹ ì²­ë°©ë²• }}</p>
                            </div>

                            <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                            <div class="flex space-x-2">
                                <button onclick="showPolicyDetail({{ loop.index0 }})" 
                                        class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600">
                                    ğŸ“‹ ìì„¸íˆ
                                </button>
                                <button onclick="createApplication('{{ policy.ì„œë¹„ìŠ¤ëª… }}')" 
                                        class="flex-1 iruda-bg-orange text-white px-3 py-2 rounded text-sm hover:opacity-90">
                                    ğŸ“ ì‹ ì²­í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                <div class="flex justify-center mt-8">
                    <div class="flex space-x-2">
                        <button class="px-3 py-2 border rounded hover:bg-gray-50">ì´ì „</button>
                        <button class="px-3 py-2 bg-orange-500 text-white rounded">1</button>
                        <button class="px-3 py-2 border rounded hover:bg-gray-50">2</button>
                        <button class="px-3 py-2 border rounded hover:bg-gray-50">ë‹¤ìŒ</button>
                    </div>
                </div>
            {% else %}
                <div class="bg-white rounded-lg shadow-md p-12 text-center">
                    <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <span class="text-4xl">ğŸ”</span>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p class="text-gray-600 mb-4">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì‹œê±°ë‚˜ í•„í„°ë¥¼ ì¡°ì •í•´ë³´ì„¸ìš”.</p>
                    <button onclick="recommendPolicies()" 
                            class="iruda-bg-orange text-white px-4 py-2 rounded-lg hover:opacity-90">
                        ğŸ¯ ë§ì¶¤ ì •ì±… ì¶”ì²œë°›ê¸°
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ì •ì±… ìƒì„¸ ëª¨ë‹¬ -->
<div id="policyDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold iruda-blue" id="modalPolicyTitle">ì •ì±… ìƒì„¸ì •ë³´</h3>
                <button onclick="closePolicyDetail()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
            </div>
            <div id="modalPolicyContent"></div>
            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t">
                <button onclick="createApplication()" id="modalApplyBtn"
                        class="iruda-bg-orange text-white px-4 py-2 rounded-lg hover:opacity-90">
                    ğŸ“ ì‹ ì²­ì„œ ì‘ì„±
                </button>
                <button onclick="closePolicyDetail()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const allPolicies = {{ policies|tojson|safe }};
let currentPolicyIndex = 0;

function searchPolicies() {
    const searchTerm = document.getElementById('searchInput').value;
    const category = document.getElementById('categoryFilter').value;
    
    let url = '/policies?';
    if (searchTerm) url += `search=${encodeURIComponent(searchTerm)}&`;
    if (category) url += `category=${encodeURIComponent(category)}&`;
    
    window.location.href = url;
}

function quickSearch(keyword) {
    document.getElementById('searchInput').value = keyword;
    searchPolicies();
}

function showPolicyDetail(index) {
    currentPolicyIndex = index;
    const policy = allPolicies[index];
    
    document.getElementById('modalPolicyTitle').textContent = policy.ì„œë¹„ìŠ¤ëª…;
    document.getElementById('modalApplyBtn').setAttribute('onclick', `createApplication('${policy.ì„œë¹„ìŠ¤ëª…}')`);
    
    const content = `
        <div class="space-y-4">
            <div>
                <h4 class="font-semibold text-gray-800 mb-2">ê¸°ê´€ ì •ë³´</h4>
                <p><strong>ê¸°ê´€ëª…:</strong> ${policy.ê¸°ê´€ëª…}</p>
                ${policy.ì—°ë½ì²˜ ? `<p><strong>ì—°ë½ì²˜:</strong> ${policy.ì—°ë½ì²˜}</p>` : ''}
            </div>
            <div>
                <h4 class="font-semibold text-gray-800 mb-2">ì§€ì›ëŒ€ìƒ</h4>
                <p class="text-sm text-gray-700">${policy.ì§€ì›ëŒ€ìƒ}</p>
            </div>
            <div>
                <h4 class="font-semibold text-gray-800 mb-2">ì§€ì›ë‚´ìš©</h4>
                <p class="text-sm text-gray-700">${policy.ì§€ì›ë‚´ìš©}</p>
            </div>
            <div>
                <h4 class="font-semibold text-gray-800 mb-2">ì‹ ì²­ë°©ë²•</h4>
                <p class="text-sm text-gray-700">${policy.ì‹ ì²­ë°©ë²•}</p>
            </div>
        </div>
    `;
    
    document.getElementById('modalPolicyContent').innerHTML = content;
    document.getElementById('policyDetailModal').classList.remove('hidden');
}

function closePolicyDetail() {
    document.getElementById('policyDetailModal').classList.add('hidden');
}

function createApplication(policyName) {
    window.open(`/application-form?policy=${encodeURIComponent(policyName)}`, '_blank');
}

function openApplicationForm() {
    window.open('/application-form', '_blank');
}

function recommendPolicies() {
    fetch('/policies/recommend', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ì¶”ì²œ ê²°ê³¼ë¡œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            window.location.href = '/policies?recommended=true';
        } else {
            alert('ì¶”ì²œ ì •ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ê²€ìƒ‰ì–´ ì…ë ¥ì‹œ ì—”í„°í‚¤ ì²˜ë¦¬
document.getElementById('searchInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        searchPolicies();
    }
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}